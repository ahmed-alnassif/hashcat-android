name: Build Android

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:  # Manual trigger

jobs:
  build-android:
    strategy:
      matrix:
        arch: [arm64, arm]
        include:
          - arch: arm64
            target: aarch64-linux-android
            clang_target: aarch64-linux-android33
          - arch: arm
            target: armv7a-linux-androideabi
            clang_target: armv7a-linux-androideabi33

    name: Build Android ${{ matrix.arch }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout hashcat-android repo
        uses: actions/checkout@v4

      - name: Setup Android NDK
        uses: android-actions/setup-android-ndk@v2
        with:
          ndk-version: '26.2.11394342'

      - name: Setup Android Toolchain
        run: |
          # Set up environment variables
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
          echo "CC=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.clang_target }}-clang" >> $GITHUB_ENV
          echo "CXX=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.clang_target }}-clang++" >> $GITHUB_ENV
          echo "AR=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar" >> $GITHUB_ENV
          echo "STRIP=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip" >> $GITHUB_ENV

      - name: Build hashcat for Android
        run: |
          cd hashcat
          
          # Set Android-specific flags
          export CFLAGS="--target=${{ matrix.clang_target}} -fPIE -fPIC"
          export LDFLAGS="--target=${{ matrix.clang_target}} -pie"
          
          # Build for Android
          make clean
          make ENABLE_LTO=0 \
               CC="$CC" \
               CXX="$CXX" \
               AR="$AR" \
               STRIP="$STRIP"

      - name: Create Android binary package
        run: |
          cd hashcat
          mkdir -p ../android-package/${{ matrix.arch }}
          cp hashcat ../android-package/${{ matrix.arch }}/
          cp -r charsets docs extra layouts masks modules OpenCL rules example* ../android-package/${{ matrix.arch }}/
          
          # Create version file
          echo "Arch: ${{ matrix.arch }}" > ../android-package/${{ matrix.arch }}/version.txt
          echo "Target: ${{ matrix.target }}" >> ../android-package/${{ matrix.arch }}/version.txt
          echo "Build: $(date -u)" >> ../android-package/${{ matrix.arch }}/version.txt

      - name: Upload Android binaries
        uses: actions/upload-artifact@v4
        with:
          name: hashcat-android-${{ matrix.arch }}
          path: android-package/${{ matrix.arch }}/
          retention-days: 30

  create-android-release:
    name: Create Android Release
    runs-on: ubuntu-latest
    needs: build-android
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all Android artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create combined release package
        run: |
          mkdir -p hashcat-android
          cp -r artifacts/hashcat-android-arm64/* hashcat-android/ 2>/dev/null || true
          cp -r artifacts/hashcat-android-arm/* hashcat-android/ 2>/dev/null || true
          
          # Create README
          cat > hashcat-android/README-Android.md << 'EOF'
          # Hashcat for Android
          
          Pre-built hashcat binaries for Android/Termux
          
          ## Supported Architectures:
          - ARM64 (aarch64)
          - ARM (armv7a)
          
          ## Usage in Termux:
          ```bash
          chmod +x hashcat
          ./hashcat --version
          ```
          
          Built from: https://github.com/ahmed-alnassif/hashcat-android
          EOF
          
          tar -czf hashcat-android-binaries.tar.gz hashcat-android/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: android-${{ github.sha }}
          name: "Hashcat Android Binaries"
          body: |
            Pre-built hashcat binaries for Android/Termux
            
            **Architectures:**
            - ✅ ARM64 (aarch64)
            - ✅ ARM (armv7a)
            
            **Usage:**
            ```bash
            tar -xzf hashcat-android-binaries.tar.gz
            cd hashcat-android
            chmod +x hashcat
            ./hashcat --version
            ```
            
            **Source:** https://github.com/ahmed-alnassif/hashcat-android
          files: hashcat-android-binaries.tar.gz
