name: Build Android

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:  # Manual trigger

jobs:
  build-android:
    strategy:
      matrix:
        arch: [arm64, arm]
        include:
          - arch: arm64
            target: aarch64-linux-android
            clang_target: aarch64-linux-android33
          - arch: arm
            target: armv7a-linux-androideabi
            clang_target: armv7a-linux-androideabi33

    name: Build Android ${{ matrix.arch }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout hashcat-android repo
        uses: actions/checkout@v4

      - name: Download Android NDK
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
          unzip -q android-ndk-r26b-linux.zip
          echo "NDK_HOME=$(pwd)/android-ndk-r26b" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$(pwd)/android-ndk-r26b" >> $GITHUB_ENV

      - name: Setup Android Toolchain
        run: |
          echo "CC=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.clang_target }}-clang" >> $GITHUB_ENV
          echo "CXX=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.clang_target }}-clang++" >> $GITHUB_ENV
          echo "AR=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar" >> $GITHUB_ENV
          echo "STRIP=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip" >> $GITHUB_ENV
          echo "RANLIB=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ranlib" >> $GITHUB_ENV

      - name: Build hashcat for Android
        run: |
          cd hashcat
          
          # Set Android-specific flags
          export CFLAGS="--target=${{ matrix.clang_target}} -fPIE -fPIC -D__ANDROID__"
          export LDFLAGS="--target=${{ matrix.clang_target}} -pie"
          export PREFIX="/system"
          
          echo "Using compiler: $CC"
          $CC --version
          
          # Build for Android
          make clean
          make ENABLE_BRAIN=0 \
               ENABLE_LTO=0 \
               CC="$CC" \
               CXX="$CXX" \
               AR="$AR" \
               STRIP="$STRIP" \
               RANLIB="$RANLIB"

      - name: Test binary
        run: |
          cd hashcat
          file hashcat
          # Check if binary is Android compatible
          $NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-readelf -h hashcat | grep "Machine\|Class" || true

      - name: Create Android binary package
        run: |
          cd hashcat
          mkdir -p ../android-package/${{ matrix.arch }}
          cp hashcat ../android-package/${{ matrix.arch }}/
          cp -r charsets docs extra layouts masks modules OpenCL rules example* ../android-package/${{ matrix.arch }}/
          
          # Create version file
          echo "Arch: ${{ matrix.arch }}" > ../android-package/${{ matrix.arch }}/version.txt
          echo "Target: ${{ matrix.target }}" >> ../android-package/${{ matrix.arch }}/version.txt
          echo "Build: $(date -u)" >> ../android-package/${{ matrix.arch }}/version.txt
          ./hashcat --version >> ../android-package/${{ matrix.arch }}/version.txt 2>/dev/null || echo "Version check failed" >> ../android-package/${{ matrix.arch }}/version.txt

      - name: Upload Android binaries
        uses: actions/upload-artifact@v4
        with:
          name: hashcat-android-${{ matrix.arch }}
          path: android-package/${{ matrix.arch }}/
          retention-days: 30